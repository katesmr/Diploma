var inherit = require("../utils/inherit");
var TrackManager = require("../utils/TrackManager");
var AudioBufferRecorder = require("./AudioBufferRecorder");
var eventDuration = require("../utils/eventDuration");

module.exports = DrumAudioBufferRecorder;

function DrumAudioBufferRecorder(drumModel){
    AudioBufferRecorder.call(this, drumModel);
    this.drumCount = 0;
    this.drumAudioBuffers = [];
}

inherit(DrumAudioBufferRecorder, AudioBufferRecorder);

DrumAudioBufferRecorder.prototype.setModel = function(drumModel){
    if(drumModel){
        this.trackModel = drumModel;
        this.drumCount = drumModel.drums.length;
        this.createTracks();
    }
};

DrumAudioBufferRecorder.prototype.createTrack = function(drumTrack){
    if(drumTrack.trackObject instanceof Tone.MembraneSynth){
        this.track = new Tone.MembraneSynth(drumTrack.setting).toMaster();
    } else if(drumTrack.trackObject instanceof Tone.Player){

    } else if(drumTrack.trackObject instanceof Tone.MetalSynth){

    }
    this.createFilters();
    this.playData = createDrumPlayData(this.trackModel.playSetting, drumTrack.instrument);
    this.duration = eventDuration.durationByTime(this.playData);
    console.log("created");
    console.log(this.playData);
    console.log(this.duration);
};

DrumAudioBufferRecorder.prototype.createTracks = function(){
    var drum;
    for(drum in this.trackModel.drumObjects){
        this.createTrack(this.trackModel.drumObjects[drum]);
    }
};

DrumAudioBufferRecorder.prototype.play = function(drumTrack, value){
    console.log(this.duration, value);
    if(drumTrack.trackObject instanceof Tone.MembraneSynth){
        this.track.triggerAttack(value.playValue, value.time);
    } else if(drumTrack.trackObject instanceof Tone.Player){

    } else if(drumTrack.trackObject instanceof Tone.MetalSynth){

    }
};

DrumAudioBufferRecorder.prototype.record = function(callback){
    var i, drumTrack;
    for(i = 0; i < this.drumCount; ++i){
        // this.trackModel.drums[i] - drum instrument name
        drumTrack = this.trackModel.drumObjects[this.trackModel.drums[i]];
        this._record(drumTrack, i, callback);
    }
};

DrumAudioBufferRecorder.prototype._record = function(drumTrack, index, callback){
    var self = this;
    Tone.Offline(function(){
        self.createTrack(drumTrack);
        console.log("offline");
        console.log(self.playData);
        var part = new Tone.Part(function(time, value){
            console.log("part");
            self.play(drumTrack, value);
        }, self.playData);
        part.start(0);
        Tone.Transport.start();
    }, this.duration).then(function(buffer){
        console.log("then");
        console.log(buffer._buffer);
        self.drumAudioBuffers.push(buffer._buffer);
        console.log(self.drumAudioBuffers);
        if(index === self.drumCount-1){
            var b = TrackManager.mergeTracks(self.drumAudioBuffers);
            //TrackManager.save(b);
        }
    });
};

function createDrumPlayData(trackPlayData, instrument){
    var events = [];
    var tmp, i, token;
    for(i = 0; i < trackPlayData.length; ++i){
        tmp = {};
        token = trackPlayData[i];
        if(token.instrument === instrument){
            tmp.time = token.startTime / 1000;
            tmp.playValue = token.playValue;
            events.push(tmp);
        }
    }
    return events;
}
